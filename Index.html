<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2D Web Hra - Multiplayer</title>
 <style>
    /* Modálne okno (vyskakovacie okno) */
    #playerInfoModal {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border: 2px solid #333;
      border-radius: 10px;
      z-index: 1000;
    }

    #playerName, #playerColor {
      margin-bottom: 10px;
      padding: 5px;
    }

    #playerInfoModal button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Zakrytie pozadia pri otvorenom modálnom okne */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Hra */
    #gameArea {
      position: relative;
      width: 600px;
      height: 500px;
      background-color: #ccc;
      border: 2px solid #333;
      margin-top: 20px;
    }

    #player {
      position: absolute;
      bottom: 50px;
      left: 50px;
      width: 30px;
      height: 30px;
      background-color: #ff6347;
    }

    .platform {
      position: absolute;
      width: 100px;
      height: 20px;
      background-color: #228b22;
    }

    #controls {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .control-button {
      width: 80px;
      height: 50px;
      font-size: 18px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Zakryté pozadie počas modálneho okna -->
  <div id="overlay" style="display: block;"></div>

  <!-- Modálne okno pre zadanie informácií o hráčovi -->
  <div id="playerInfoModal">
    <label for="playerName">Meno postavy:</label>
    <input type="text" id="playerName" placeholder="Zadaj meno">
    <label for="playerColor">Farba postavy:</label>
    <input type="color" id="playerColor" value="#ff6347">
    <button id="startGameButton">Začať hru</button>
  </div>

  <!-- Hlavný herný priestor -->
  <div id="gameArea">
    <div id="player"></div>
    <div class="platform" style="top: 400px; left: 100px;"></div>
    <div class="platform" style="top: 300px; left: 250px;"></div>
  </div>

  <div id="controls">
    <button id="leftButton">Doľava</button>
    <button id="jumpButton">Skok</button>
    <button id="rightButton">Doprava</button>
    <button id="clearPlayersButton" style="background-color: red;">Odstrániť všetkých hráčov</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcWybZJwg1r1-W7XcUxAd8_DWpcP0mikc",
      authDomain: "prdddd-84ff6.firebaseapp.com",
      databaseURL: "https://prdddd-84ff6-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "prdddd-84ff6",
      storageBucket: "prdddd-84ff6.appspot.com",
      messagingSenderId: "438641142386",
      appId: "1:438641142386:web:a76ce69c3d2c810621b0eb",
      measurementId: "G-2KMMEZGXZB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const player = document.getElementById("player");
    const gameArea = document.getElementById("gameArea");
    const playerInfoModal = document.getElementById("playerInfoModal");
    const overlay = document.getElementById("overlay");
    const playerNameInput = document.getElementById("playerName");
    const playerColorInput = document.getElementById("playerColor");
    const startGameButton = document.getElementById("startGameButton");
    const playerId = `player_${Math.random().toString(36).substr(2, 9)}`;
    let playerX = 50, playerY = 450, velocityY = 0;
    const speed = 5, gravity = 0.5, jumpStrength = -10;
    let onGround = false;

    let playerName = '';
    let playerColor = '#ff6347';

    // Zobraziť modálne okno pre zadanie informácií
    startGameButton.addEventListener("click", () => {
      playerName = playerNameInput.value;
      playerColor = playerColorInput.value;

      // Zavrieme okno a zobrazíme hru
      playerInfoModal.style.display = "none";
      overlay.style.display = "none";

      // Uložíme meno a farbu do Firebase
      savePlayer();
    });

    function savePlayer() {
      set(ref(db, `players/${playerId}`), { 
        x: playerX, 
        y: playerY,
        name: playerName,
        color: playerColor
      });
    }

    function removePlayer() {
      remove(ref(db, `players/${playerId}`));
    }

    onValue(ref(db, 'players'), (snapshot) => {
      const players = snapshot.val();

      document.querySelectorAll('.other-player').forEach(otherPlayer => otherPlayer.remove());

      for (let id in players) {
        if (id !== playerId) {
          let otherPlayer = document.getElementById(id);
          if (!otherPlayer) {
            otherPlayer = document.createElement("div");
            otherPlayer.id = id;
            otherPlayer.classList.add("other-player");
            otherPlayer.style.position = "absolute";
            otherPlayer.style.width = "30px";
            otherPlayer.style.height = "30px";
            gameArea.appendChild(otherPlayer);
          }
          otherPlayer.style.left = players[id].x + "px";
          otherPlayer.style.top = players[id].y + "px";
          otherPlayer.style.backgroundColor = players[id].color;

          // Vytvorenie a zobrazenie mena nad postavou
          const playerNameLabel = document.createElement("div");
          playerNameLabel.textContent = players[id].name;
          playerNameLabel.style.position = "absolute";
          playerNameLabel.style.top = "-20px";
          playerNameLabel.style.textAlign = "center";
          otherPlayer.appendChild(playerNameLabel);
        }
      }
    });

    function detectPlayerCollision() {
      const playerRect = player.getBoundingClientRect();
      let collided = false;

      document.querySelectorAll('.other-player').forEach(otherPlayer => {
        const otherRect = otherPlayer.getBoundingClientRect();

        if (
          playerRect.right > otherRect.left &&
          playerRect.left < otherRect.right &&
          playerRect.bottom <= otherRect.top + 5 &&
          playerRect.bottom >= otherRect.top - velocityY
        ) {
          playerY = otherRect.top - playerRect.height - gameArea.getBoundingClientRect().top;
          velocityY = 0;
          onGround = true;
          collided = true;
        }
      });
      return collided;
    }

    document.getElementById("leftButton").addEventListener("mousedown", () => { playerX -= speed; savePlayer(); });
    document.getElementById("rightButton").addEventListener("mousedown", () => { playerX += speed; savePlayer(); });
    document.getElementById("jumpButton").addEventListener("mousedown", () => { if (onGround) { velocityY = jumpStrength; onGround = false; savePlayer(); } });

    document.getElementById("clearPlayersButton").addEventListener("click", () => {
      if (confirm("Naozaj chcete odstrániť všetkých hráčov?")) {
        remove(ref(db, 'players'));
      }
    });

    // Používame navigator.sendBeacon pre odosielanie údajov pri zavretí okna
    window.addEventListener("unload", () => {
      navigator.sendBeacon("/deletePlayer", JSON.stringify({ playerId }));
      removePlayer();
    });

    function update() {
      velocityY += gravity;
      playerY += velocityY;

      if (!detectPlayerCollision()) {
        if (playerY > gameArea.clientHeight - player.offsetHeight) {
          playerY = gameArea.clientHeight - player.offsetHeight;
          velocityY = 0;
          onGround = true;
        }
      }

      player.style.left = `${playerX}px`;
      player.style.top = `${playerY}px`;

      savePlayer();

      requestAnimationFrame(update);
    }

    // Ovládanie pomocou šípok
    document.addEventListener("keydown", (event) => {
      switch (event.key) {
        case "ArrowLeft":
          playerX -= speed;
          savePlayer();
          break;
        case "ArrowRight":
          playerX += speed;
          savePlayer();
          break;
        case "ArrowUp":
          if (onGround) {
            velocityY = jumpStrength;
            onGround = false;
            savePlayer();
          }
          break;
      }
    });

    update();
  </script>

</body>
</html>
